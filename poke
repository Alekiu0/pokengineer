<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POKENGINEER v5.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #050505;
            --panel-bg: rgba(20, 20, 25, 0.95);
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-gold: #ffd700;
            --neon-green: #00ff9d;
            --text-dim: #888;
            --grid-line: rgba(0, 243, 255, 0.1);
            --font-main: 'Share Tech Mono', monospace;
        }

        body {
            background-color: #000;
            color: var(--neon-blue);
            font-family: var(--font-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            /* Fondo de rejilla estilo TRON/Blueprint */
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        #device {
            width: 100%;
            max-width: 480px;
            height: 95vh;
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            background: radial-gradient(circle at center, #1a1a24 0%, #000 100%);
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.15);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* --- CINEMATICS & INTRO --- */
        #cinematic-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            transition: opacity 0.5s;
        }

        /* Avatar Hologr√°fico CSS */
        .holo-avatar {
            width: 120px;
            height: 120px;
            border: 2px solid var(--neon-blue);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 20px var(--neon-blue);
            margin-bottom: 20px;
            animation: holoPulse 2s infinite alternate;
            position: relative;
        }
        .holo-avatar::after {
            content: '';
            position: absolute;
            width: 100%; height: 5px;
            background: rgba(0, 243, 255, 0.5);
            animation: scanline 2s linear infinite;
            top: 0;
            opacity: 0.5;
        }

        .dialog-box {
            width: 100%;
            background: var(--panel-bg);
            border: 1px solid var(--neon-blue);
            padding: 15px;
            margin-top: 20px;
            min-height: 100px;
            border-radius: 5px;
            position: relative;
        }
        
        .dialog-text {
            font-size: 16px;
            line-height: 1.4;
            color: #fff;
            text-shadow: 0 0 5px var(--neon-blue);
        }

        .next-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--neon-blue);
            color: #000;
            border: none;
            padding: 5px 15px;
            font-family: var(--font-main);
            font-weight: bold;
            cursor: pointer;
            animation: blink 1s infinite;
        }

        /* --- GAME UI --- */
        header {
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid var(--neon-blue);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            text-transform: uppercase;
        }

        /* --- BATTLE AREA --- */
        #arena {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .mon-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .mon-row.enemy { flex-direction: row-reverse; align-self: flex-end; }
        
        .sprite-container {
            width: 90px;
            height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
            animation: float 3s ease-in-out infinite;
        }
        
        .shiny { filter: hue-rotate(180deg) drop-shadow(0 0 15px var(--neon-gold)) !important; }

        .stat-card {
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--text-dim);
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 120px;
        }

        .bar-wrap { height: 6px; background: #333; margin-top: 4px; border-radius: 2px; overflow: hidden; }
        .bar-hp { height: 100%; background: linear-gradient(90deg, #ff4d4d, #ff9966); transition: width 0.3s; }
        .bar-xp { height: 4px; background: linear-gradient(90deg, #00c6ff, #0072ff); margin-top:2px; }

        /* --- LOG CONSOLE --- */
        #console-wrapper {
            height: 100px;
            background: rgba(0,0,0,0.9);
            border-top: 1px solid var(--neon-blue);
            border-bottom: 1px solid var(--neon-blue);
            padding: 10px;
            overflow-y: auto;
            font-size: 13px;
            display: flex;
            flex-direction: column-reverse; /* Newest at bottom visually, handled by JS prepending */
        }
        
        .log-msg { margin-bottom: 4px; border-left: 2px solid #333; padding-left: 8px; }
        .log-new { border-left-color: var(--neon-green); color: #fff; animation: slideIn 0.3s; }
        .log-crit { border-left-color: var(--neon-pink); color: var(--neon-pink); }

        /* --- CONTROLS --- */
        #controls {
            padding: 10px;
            background: #0b0b0b;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 8px;
            height: 160px;
        }
        
        button {
            background: #111;
            border: 1px solid #444;
            color: var(--neon-blue);
            font-family: var(--font-main);
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover { background: #222; border-color: var(--neon-blue); color: #fff; }
        
        .action-btn { font-size: 14px; position: relative; }
        .type-label { font-size: 9px; position: absolute; bottom: 2px; right: 4px; opacity: 0.7; }

        /* --- MODALS --- */
        .modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 50;
            display: none;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal.active { display: flex; }

        .list-item {
            display: flex;
            align-items: center;
            background: #111;
            border: 1px solid #333;
            margin-bottom: 5px;
            padding: 8px;
        }
        .list-item.fav { border-color: var(--neon-gold); }
        .star-btn { font-size: 20px; cursor: pointer; margin-right: 10px; color: #444; }
        .star-btn.active { color: var(--neon-gold); text-shadow: 0 0 5px var(--neon-gold); }

        /* --- SETTINGS BTN --- */
        #settings-btn {
            position: absolute;
            top: 10px; right: 10px;
            background: transparent; border: none;
            color: #555; font-size: 16px; cursor: pointer;
            z-index: 200;
        }
        #settings-btn:hover { color: var(--neon-pink); }

        /* ANIMATIONS */
        @keyframes holoPulse { from { opacity: 0.8; box-shadow: 0 0 10px var(--neon-blue); } to { opacity: 1; box-shadow: 0 0 25px var(--neon-blue); } }
        @keyframes scanline { 0% { top: 0%; } 100% { top: 100%; } }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
        @keyframes slideIn { from{transform:translateX(-10px); opacity:0;} to{transform:translateX(0); opacity:1;} }
        @keyframes shake { 0%{transform:translate(0)} 25%{transform:translate(-5px)} 75%{transform:translate(5px)} 100%{transform:translate(0)} }
        .shake { animation: shake 0.4s; }

        /* BOSS ALERT */
        #boss-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 85, 0.2);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            pointer-events: none;
        }
        .boss-text {
            font-size: 40px; color: var(--neon-pink); font-weight: bold;
            text-shadow: 0 0 10px var(--neon-pink);
            transform: rotate(-10deg);
            border: 4px solid var(--neon-pink);
            padding: 10px 40px;
            background: #000;
        }
    </style>
</head>
<body>

<div id="device">
    
    <button id="settings-btn" onclick="confirmReset()">‚öôÔ∏è REINICIAR</button>

    <!-- INTRO LAYER -->
    <div id="cinematic-layer">
        <div class="holo-avatar">üë®‚Äçüíª</div>
        <h2 style="color:var(--neon-blue); margin:0; text-shadow:0 0 10px var(--neon-blue);">ING. ATLAS</h2>
        <div style="font-size:10px; color:#666; letter-spacing:2px; margin-bottom:20px;">JEFE DE OPERACIONES I+D</div>
        
        <div class="dialog-box">
            <div class="dialog-text" id="intro-text"></div>
            <button class="next-btn" id="intro-next-btn" onclick="nextIntro()">CONTINUAR >></button>
        </div>

        <div id="starter-choice" style="display:none; gap:20px; margin-top:20px;">
            <button onclick="pickStarter(0)" style="padding:15px; font-size:24px;">üî• A</button>
            <button onclick="pickStarter(1)" style="padding:15px; font-size:24px;">üíß B</button>
            <button onclick="pickStarter(2)" style="padding:15px; font-size:24px;">üåø C</button>
        </div>
    </div>

    <!-- GAME HEADER -->
    <header>
        <div>ACTIVO: <span id="head-active">...</span></div>
        <div>FASE: <span id="head-stage">1</span></div>
        <div style="color:var(--neon-gold)">CR: <span id="head-cr">0</span></div>
    </header>

    <!-- BATTLE ARENA -->
    <div id="arena">
        <div id="boss-overlay"><div class="boss-text">ALERTA JEFE</div></div>

        <!-- Enemy -->
        <div class="mon-row enemy">
            <div class="sprite-container" id="enemy-sprite">ü§ñ</div>
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between; font-size:12px;">
                    <span id="enemy-name">Enemy</span>
                    <span style="color:var(--neon-pink)">Nv.<span id="enemy-lvl">1</span></span>
                </div>
                <div class="bar-wrap"><div class="bar-hp" id="enemy-hp"></div></div>
            </div>
        </div>

        <!-- Player -->
        <div class="mon-row player" style="margin-top:auto;">
            <div class="sprite-container" id="player-sprite">ü§†</div>
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between; font-size:12px;">
                    <span id="player-name">Player</span>
                    <span style="color:var(--neon-green)">Nv.<span id="player-lvl">1</span></span>
                </div>
                <div class="bar-wrap"><div class="bar-hp" id="player-hp"></div></div>
                <div style="text-align:right; font-size:10px; color:#aaa;"><span id="player-hp-txt"></span></div>
                <div class="bar-wrap" style="height:4px; margin-top:4px;"><div class="bar-xp" id="player-xp"></div></div>
            </div>
        </div>
    </div>

    <!-- LOG CONSOLE -->
    <div id="console-wrapper">
        <div class="log-msg">Sistema de batalla iniciado...</div>
    </div>

    <!-- CONTROLS -->
    <div id="controls">
        <div id="combat-menu" style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
            <!-- Buttons injected here -->
        </div>
        
        <div id="system-menu" style="display:grid; grid-template-rows:1fr 1fr; gap:5px;">
            <button onclick="openTeam()" style="border-color:var(--neon-blue);">üë• EQUIPO / FAV</button>
            <button onclick="attemptCatch()" style="border-color:var(--neon-gold); color:var(--neon-gold);">üì¶ CAPTURAR</button>
        </div>

        <!-- Boss Defeat Menu (Hidden by default) -->
        <div id="loss-menu" style="display:none; grid-column:1/-1; text-align:center;">
            <div style="color:var(--neon-pink); margin-bottom:10px;">¬°MISI√ìN FALLIDA! EL JEFE ES DEMASIADO FUERTE.</div>
            <button onclick="startTraining()" style="width:100%; padding:15px; background:var(--neon-green); color:#000;">üèãÔ∏è ENTRENAMIENTO SIMULADO (GRIND)</button>
        </div>
    </div>

    <!-- MODAL TEAM -->
    <div id="modal-team" class="modal">
        <h3 style="color:var(--neon-blue); border-bottom:1px solid #333;">GESTI√ìN DE ACTIVOS</h3>
        <p style="font-size:10px; color:#666;">‚≠ê = Favorito (Prioridad en lista)</p>
        <div id="team-list" style="flex-grow:1; overflow-y:auto;"></div>
        <button onclick="closeTeam()" style="padding:15px; margin-top:10px;">CERRAR</button>
    </div>

</div>

<script>
    /* === DATABASE === */
    const TYPES = { FUEGO:'fuego', AGUA:'agua', PLANTA:'planta', MECH:'mech', ELEC:'elec' };
    const MOVES = {
        'fuego': ['Llamarada', 'Fundici√≥n', 'Soldar', 'Quemar'],
        'agua': ['Presi√≥n', 'Hidr√°ulica', 'Purga', 'Refrigerar'],
        'planta': ['Biomasa', 'Ra√≠z', 'Cosecha', 'Espina'],
        'mech': ['Prensa', 'Taladro', 'Tuerca', 'Ensamblar'],
        'elec': ['Voltaje', 'Corto', 'Carga', 'Rayo']
    };
    const DEX = [
        {id:0, n:"CalderaBot", t:TYPES.FUEGO, s:"üî•"},
        {id:1, n:"HydroPump", t:TYPES.AGUA, s:"üíß"},
        {id:2, n:"BioGen", t:TYPES.PLANTA, s:"üåø"},
        {id:3, n:"LogicGate", t:TYPES.ELEC, s:"üíæ"},
        {id:4, n:"Conveyor", t:TYPES.MECH, s:"‚öôÔ∏è"},
        {id:5, n:"SolarPanel", t:TYPES.ELEC, s:"‚òÄÔ∏è"},
        {id:6, n:"CementMixer", t:TYPES.MECH, s:"üèóÔ∏è"},
        {id:7, n:"FiberOptic", t:TYPES.ELEC, s:"‚ú®"},
        {id:8, n:"RustyPipe", t:TYPES.AGUA, s:"üö∞"},
        {id:9, n:"Recycler", t:TYPES.PLANTA, s:"‚ôªÔ∏è"},
        {id:10, n:"Turbine", t:TYPES.AGUA, s:"üåÄ"},
        {id:11, n:"ToxicWaste", t:TYPES.PLANTA, s:"‚ò£Ô∏è"},
        {id:12, n:"Mainframe", t:TYPES.ELEC, s:"üñ•Ô∏è"},
        {id:99, n:"OMEGA-BOSS", t:TYPES.MECH, s:"üëπ", boss:true}
    ];

    /* === GAME STATE === */
    let state = {
        credits: 100,
        stage: 1, // Progression
        team: [],
        activeIdx: 0,
        enemy: null,
        mode: 'intro', // intro, battle, boss, grind
        introStep: 0,
        turn: true
    };

    /* === INTRO SYSTEM === */
    const introLines = [
        "Iniciando secuencia de arranque... [OK]",
        "Bienvenido, Ingeniero. Soy Atlas, el administrador de esta planta.",
        "Nuestra misi√≥n es la eficiencia total mediante batallas automatizadas.",
        "Necesito que selecciones un prototipo inicial de la l√≠nea de ensamblaje.",
        "CHOICE",
        "Excelente. Tu ID ha sido registrado. Comencemos la Fase 1."
    ];

    function nextIntro() {
        const txt = document.getElementById('intro-text');
        const btn = document.getElementById('intro-next-btn');
        
        if (state.introStep >= introLines.length) {
            // End Intro
            document.getElementById('cinematic-layer').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('cinematic-layer').style.display = 'none';
                initBattle(false); // Normal battle start
            }, 500);
            return;
        }

        const line = introLines[state.introStep];
        
        if (line === "CHOICE") {
            txt.innerText = "Por favor, selecciona una unidad.";
            btn.style.display = 'none';
            document.getElementById('starter-choice').style.display = 'flex';
        } else {
            // Typewriter effect simple
            txt.innerText = line;
            state.introStep++;
        }
    }

    function pickStarter(id) {
        state.team.push(createMon(id, 5));
        document.getElementById('starter-choice').style.display = 'none';
        document.getElementById('intro-next-btn').style.display = 'block';
        state.introStep++; // Skip choice placeholder
        nextIntro();
    }

    // Start with first line
    nextIntro();

    /* === CORE ENGINE === */
    function createMon(id, lvl, isShinyOverride=false) {
        const proto = DEX[id];
        const isShiny = isShinyOverride || Math.random() < 0.1;
        const moves = MOVES[proto.t];
        
        return {
            ...proto,
            lvl: lvl,
            maxHp: 50 + (lvl * 12) + (proto.boss ? 200 : 0),
            hp: 50 + (lvl * 12) + (proto.boss ? 200 : 0),
            xp: 0,
            xpNext: 100 * lvl,
            moves: moves,
            shiny: isShiny,
            fav: false // Favorito
        };
    }

    function initBattle(isGrind = false) {
        state.mode = isGrind ? 'grind' : 'battle';
        state.turn = true;
        
        // Reset controls
        document.getElementById('combat-menu').style.display = 'grid';
        document.getElementById('system-menu').style.display = 'grid';
        document.getElementById('loss-menu').style.display = 'none';

        // Check Boss Gate
        if (!isGrind && state.stage % 10 === 0) {
            state.mode = 'boss';
            spawnBoss();
        } else {
            spawnRandomEnemy(isGrind);
        }
        
        updateUI();
    }

    function spawnBoss() {
        log("‚ö†Ô∏è ALERTA: Se√±al de Gran Magnitud detectada.", "crit");
        document.getElementById('boss-overlay').style.display = 'flex';
        
        // Create scaled boss
        state.enemy = createMon(13, state.stage + 5); 
        state.enemy.n = "BOSS MK-" + (state.stage/10);
        
        setTimeout(() => document.getElementById('boss-overlay').style.display = 'none', 2000);
    }

    function spawnRandomEnemy(isGrind) {
        const id = Math.floor(Math.random() * 13);
        // If grinding, enemies are slightly weaker than current stage
        const lvlBase = isGrind ? state.team[state.activeIdx].lvl : state.stage;
        const lvl = Math.max(1, lvlBase + Math.floor(Math.random()*3)-1);
        
        state.enemy = createMon(id, lvl);
        log(`Iniciando combate: ${state.enemy.n} (Nv.${lvl}) detectado.`);
        if(state.enemy.shiny) log("¬°VARIACI√ìN SHINY DETECTADA! (Recompensa x3)", "crit");
    }

    /* === COMBAT SYSTEM === */
    function attack(moveIdx) {
        if(!state.turn) return;

        const p = state.team[state.activeIdx];
        const e = state.enemy;
        const moveName = p.moves[moveIdx];

        // Player Attack
        const dmg = Math.floor(p.lvl * 2.5 + 10 + Math.random()*5);
        e.hp -= dmg;
        animateShake('enemy-sprite');
        log(`> ${p.n} us√≥ ${moveName}. Da√±o: ${dmg}`);

        if(e.hp <= 0) {
            e.hp = 0;
            winBattle();
            return;
        }

        // Enemy Turn Delay
        state.turn = false;
        updateUI();
        
        setTimeout(() => {
            const eDmg = Math.floor(e.lvl * 2 + 5);
            p.hp -= eDmg;
            animateShake('player-sprite');
            log(`> Enemigo atac√≥. Da√±o: ${eDmg}`, "crit");
            
            if(p.hp <= 0) {
                p.hp = 0;
                log(`¬°${p.n} ha colapsado!`, "crit");
                // Check if team has others
                const alive = state.team.some(m => m.hp > 0);
                if(!alive) {
                    loseBattle();
                } else {
                    openTeam(); // Force swap
                }
            }
            state.turn = true;
            updateUI();
        }, 1000);
    }

    function winBattle() {
        const e = state.enemy;
        const isBoss = state.mode === 'boss';
        
        let reward = isBoss ? 500 : (30 + e.lvl * 5);
        if(e.shiny) reward *= 3;
        
        state.credits += reward;
        log(`COMBATE FINALIZADO. Ganaste ${reward} CR.`);
        
        // XP Logic
        const p = state.team[state.activeIdx];
        const xpGain = isBoss ? 500 : (50 + e.lvl * 10);
        p.xp += xpGain;
        if(p.xp >= p.xpNext) {
            p.lvl++;
            p.xp = 0;
            p.maxHp += 15;
            p.hp = p.maxHp;
            log(`¬°NIVEL UP! ${p.n} sube a Nv.${p.lvl}.`);
        }

        if(state.mode === 'battle' || state.mode === 'boss') {
            state.stage++;
        }
        
        setTimeout(() => initBattle(false), 2000);
    }

    function loseBattle() {
        log("TODAS LAS UNIDADES FUERA DE SERVICIO.", "crit");
        // Partial heal
        state.team.forEach(m => m.hp = Math.floor(m.maxHp * 0.5));
        
        if(state.mode === 'boss') {
            document.getElementById('combat-menu').style.display = 'none';
            document.getElementById('system-menu').style.display = 'none';
            document.getElementById('loss-menu').style.display = 'block';
            log("No puedes avanzar hasta vencer al Jefe.", "crit");
        } else {
            log("Retirada t√°ctica. Reiniciando encuentro...");
            setTimeout(() => initBattle(false), 2000);
        }
    }

    function attemptCatch() {
        if(state.mode === 'boss') { log("¬°No puedes capturar a un JEFE!", "crit"); return; }
        if(state.credits < 50) { log("Fondos insuficientes (Req: 50 CR).", "crit"); return; }

        state.credits -= 50;
        const chance = (1 - (state.enemy.hp / state.enemy.maxHp)) * 2;
        log("Lanzando c√°psula de contenci√≥n...");
        
        setTimeout(() => {
            if(Math.random() < chance) {
                log("¬°CAPTURA EXITOSA! Unidad a√±adida al inventario.");
                state.enemy.hp = state.enemy.maxHp;
                state.team.push(state.enemy);
                winBattle(); // Count as win but capture
            } else {
                log("Fallo en la captura.");
                state.turn = false;
                setTimeout(() => { state.turn = true; log("Turno enemigo saltado (aturdido)."); updateUI(); }, 800);
            }
            updateUI();
        }, 1000);
    }

    function startTraining() {
        log("Iniciando simulaci√≥n de entrenamiento...");
        initBattle(true); // Grind mode
    }

    /* === UI & UTILS === */
    function log(msg, type="norm") {
        const wrap = document.getElementById('console-wrapper');
        const div = document.createElement('div');
        div.className = `log-msg ${type === 'crit' ? 'log-crit' : 'log-new'}`;
        div.innerText = msg;
        wrap.insertBefore(div, wrap.firstChild); // Prepend
    }

    function animateShake(id) {
        const el = document.getElementById(id);
        el.classList.add('shake');
        setTimeout(()=>el.classList.remove('shake'), 400);
    }

    function updateUI() {
        // Header
        document.getElementById('head-stage').innerText = state.stage;
        document.getElementById('head-cr').innerText = state.credits;
        document.getElementById('head-active').innerText = state.team[state.activeIdx].n;

        // Player
        const p = state.team[state.activeIdx];
        document.getElementById('player-name').innerText = p.n;
        document.getElementById('player-lvl').innerText = p.lvl;
        document.getElementById('player-sprite').innerText = p.s;
        if(p.shiny) document.getElementById('player-sprite').classList.add('shiny');
        else document.getElementById('player-sprite').classList.remove('shiny');

        const pHp = (p.hp / p.maxHp)*100;
        document.getElementById('player-hp').style.width = `${pHp}%`;
        document.getElementById('player-hp-txt').innerText = `${p.hp}/${p.maxHp}`;
        document.getElementById('player-xp').style.width = `${(p.xp/p.xpNext)*100}%`;

        // Enemy
        const e = state.enemy;
        document.getElementById('enemy-name').innerText = e.n;
        document.getElementById('enemy-lvl').innerText = e.lvl;
        document.getElementById('enemy-sprite').innerText = e.s;
        if(e.shiny) document.getElementById('enemy-sprite').classList.add('shiny');
        else document.getElementById('enemy-sprite').classList.remove('shiny');

        const eHp = (e.hp / e.maxHp)*100;
        document.getElementById('enemy-hp').style.width = `${eHp}%`;

        // Buttons
        const grid = document.getElementById('combat-menu');
        grid.innerHTML = '';
        p.moves.forEach((m, i) => {
            const btn = document.createElement('button');
            btn.className = 'action-btn';
            btn.innerHTML = `${m} <span class="type-label">${p.t}</span>`;
            btn.onclick = () => attack(i);
            grid.appendChild(btn);
        });
    }

    /* === TEAM MANAGEMENT === */
    function openTeam() {
        const list = document.getElementById('team-list');
        list.innerHTML = '';

        // Sort: Active > Fav > Others
        const sorted = state.team.map((m, i) => ({...m, orgIdx: i}))
            .sort((a, b) => {
                if(a.orgIdx === state.activeIdx) return -1;
                if(b.orgIdx === state.activeIdx) return 1;
                return Number(b.fav) - Number(a.fav);
            });

        sorted.forEach(m => {
            const row = document.createElement('div');
            row.className = `list-item ${m.fav ? 'fav' : ''}`;
            
            // Star Btn
            const star = document.createElement('span');
            star.className = `star-btn ${m.fav ? 'active' : ''}`;
            star.innerHTML = '‚òÖ';
            star.onclick = (e) => {
                e.stopPropagation();
                toggleFav(m.orgIdx);
            };

            const info = document.createElement('div');
            info.style.flexGrow = 1;
            info.innerHTML = `
                <div>${m.s} <strong>${m.n}</strong> (Nv.${m.lvl})</div>
                <div style="font-size:10px; color:#888;">HP: ${m.hp}/${m.maxHp} ${m.orgIdx === state.activeIdx ? '[ACTIVO]' : ''}</div>
            `;
            
            // Click row to swap
            row.onclick = () => swapMon(m.orgIdx);

            row.appendChild(star);
            row.appendChild(info);
            list.appendChild(row);
        });

        document.getElementById('modal-team').style.display = 'flex';
    }

    function toggleFav(realIdx) {
        state.team[realIdx].fav = !state.team[realIdx].fav;
        openTeam(); // Re-render
    }

    function swapMon(realIdx) {
        if(state.team[realIdx].hp <= 0) {
            alert("Esta unidad necesita reparaciones.");
            return;
        }
        state.activeIdx = realIdx;
        closeTeam();
        updateUI();
        log(`Unidad desplegada: ${state.team[realIdx].n}`);
    }

    function closeTeam() {
        document.getElementById('modal-team').style.display = 'none';
    }

    /* === SYSTEM === */
    function confirmReset() {
        if(confirm("¬øEST√ÅS SEGURO? Esto borrar√° todo tu progreso de f√°brica.")) {
            location.reload();
        }
    }

</script>
</body>
</html>
