<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POKENGINEER v23.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #020205;
            --neon-blue: #00f3ff;
            --neon-green: #00ff9d;
            --neon-pink: #ff0055;
            --neon-gold: #ffd700;
            --neon-purple: #bd00ff;
            
            --font-head: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
        }

        body {
            background: #000; margin: 0; height: 100dvh; width: 100vw;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            font-family: var(--font-body); color: #fff;
            background-image: radial-gradient(circle at 50% 50%, #050510 0%, #000 100%);
            touch-action: none;
        }

        #device {
            width: 100%; max-width: 480px; height: 100%;
            border: 2px solid var(--neon-blue); border-radius: 8px;
            background: #050505;
            display: flex; flex-direction: column; position: relative;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
            overflow: hidden;
        }

        /* --- CAPA DE TRANSICI√ìN (FLASH) --- */
        #transition-layer {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #fff; opacity: 0; pointer-events: none; z-index: 999;
        }
        .anim-flash { animation: flashEffect 0.6s ease-out forwards; }
        @keyframes flashEffect {
            0% { opacity: 0; background: #fff; }
            20% { opacity: 1; background: #fff; }
            50% { opacity: 1; background: #000; }
            100% { opacity: 0; pointer-events: none; }
        }

        /* --- PANTALLA DE INICIO / HISTORIA --- */
        #intro-screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column; padding: 30px; box-sizing: border-box;
            overflow-y: auto;
        }
        
        .typewriter-text {
            color: var(--neon-green); font-family: 'Courier New', monospace;
            font-size: 14px; line-height: 1.6; margin-bottom: 20px;
            border-left: 2px solid var(--neon-blue); padding-left: 10px;
            white-space: pre-wrap;
        }

        #intro-form { display: none; opacity: 0; transition: opacity 1s; }
        #intro-form.visible { display: flex; opacity: 1; flex-direction: column; }

        .input-group { margin-bottom: 20px; }
        input {
            background: #111; border: 1px solid var(--neon-blue); color: #fff;
            padding: 10px; width: 100%; font-family: var(--font-head);
            box-sizing: border-box; font-size: 16px; text-align: center;
        }
        .starter-container { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .starter-card {
            border: 1px solid #333; background: #111; padding: 10px; cursor: pointer;
            width: 30%; text-align: center; transition: 0.3s;
        }
        .starter-card:hover, .starter-card.selected {
            border-color: var(--neon-gold); background: #222; transform: scale(1.05); box-shadow: 0 0 10px var(--neon-gold);
        }

        /* --- VISTAS --- */
        .view-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; z-index: 10;
            background: #000;
        }
        .view-layer.active { display: flex; }

        /* ================= MAPA ================= */
        #map-container {
            flex-grow: 1; display: grid; gap: 1px; background: #111;
            align-content: center; justify-content: center;
        }
        .tile { display: flex; justify-content: center; align-items: center; font-size: 14px; position: relative; }
        .tile-wall { background: #222; }
        .tile-floor { background: #050505; }
        .tile-grass { background: rgba(0, 243, 255, 0.05); border: 1px solid rgba(0, 243, 255, 0.15); }
        .tile-boss { background: rgba(255, 0, 85, 0.2); border: 1px solid var(--neon-pink); animation: pulseRed 1s infinite; }
        
        .entity-player { font-size: 24px; z-index: 5; text-shadow: 0 0 10px var(--neon-blue); }

        #map-ui {
            height: 220px; background: rgba(10,15,20,0.98); border-top: 2px solid var(--neon-green);
            padding: 10px; display: flex; flex-direction: column; gap: 10px;
        }
        .map-stats { display: flex; justify-content: space-between; font-size: 12px; color: var(--neon-blue); background: #000; padding: 5px; border: 1px solid #333; }
        
        .dpad-container { display: flex; justify-content: center; align-items: center; flex-grow: 1;}
        .dpad { display: grid; grid-template-columns: 40px 40px 40px; grid-template-rows: 40px 40px 40px; }
        .dpad-btn { background: #222; border: 1px solid #444; color: #fff; display: flex; justify-content: center; align-items: center; cursor: pointer; user-select: none; }
        .dpad-btn:active { background: var(--neon-green); color: #000; }

        .map-menu-bar { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; }
        .map-menu-btn { background: #080808; border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 8px 0; cursor: pointer; }

        /* ================= BATALLA ================= */
        header { padding: 8px 12px; border-bottom: 2px solid var(--neon-blue); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.8); }

        #arena {
            flex-grow: 1; position: relative; padding: 20px; display: flex; flex-direction: column; justify-content: space-between;
            background-image: linear-gradient(rgba(0,243,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,243,255,0.05) 1px, transparent 1px);
            background-size: 30px 30px; perspective: 600px;
        }

        .mon-container { display: flex; flex-direction: column; width: 140px; }
        .mon-container.enemy { align-self: flex-end; align-items: flex-end; }
        .mon-container.player { align-self: flex-start; align-items: flex-start; }

        .holo-chip {
            width: 120px; height: 120px; background: rgba(0,0,0,0.6); border: 2px solid var(--neon-blue);
            display: flex; justify-content: center; align-items: center;
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }
        .enemy .holo-chip { border-color: var(--neon-pink); box-shadow: 0 0 15px rgba(255, 0, 85, 0.3); }

        .holo-sprite { font-size: 70px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); animation: holoFloat 3s ease-in-out infinite; }
        .shiny .holo-sprite { filter: hue-rotate(180deg) drop-shadow(0 0 10px var(--neon-gold)); }

        .hud { width: 100%; padding: 5px; margin-top: 5px; background: rgba(0,0,0,0.8); border: 1px solid #333; border-left: 3px solid var(--neon-blue); font-size: 12px; }
        .enemy .hud { border-left: none; border-right: 3px solid var(--neon-pink); text-align: right; }
        
        .bar-wrap { height: 6px; background: #222; margin-top: 4px; border-radius: 3px; overflow: hidden; position: relative; }
        .hp-fill { height: 100%; transition: width 0.5s; background: linear-gradient(90deg, #ff3333, #ffff00, #00ff00); }
        
        .xp-wrap { height: 3px; background: #111; margin-top: 2px; width: 100%; }
        .xp-fill { height: 100%; background: var(--neon-blue); width: 0%; transition: width 0.5s; box-shadow: 0 0 5px var(--neon-blue); }

        #console { height: 80px; background: rgba(0,0,0,0.95); border-top: 1px solid var(--neon-blue); padding: 8px; font-size: 11px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .log-entry { margin-bottom: 2px; color: #ccc; }
        
        #controls { padding: 8px; background: #080808; border-top: 1px solid #333; display: grid; grid-template-columns: 2fr 1fr; gap: 6px; height: 140px; flex-shrink: 0; }
        
        .atk-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        
        .atk-btn { 
            font-size: 13px; text-align: center; padding: 10px 5px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; text-shadow: 0 1px 2px #000;
            cursor: pointer; transition: filter 0.2s;
            font-family: var(--font-body); font-weight: bold;
        }
        .atk-btn:active { filter: brightness(1.2); transform: translateY(2px); }
        .atk-btn small { font-size: 9px; opacity: 0.8; font-weight: normal; margin-top: 2px;}

        button.ui-btn { background: #111; border: 1px solid #444; color: #fff; cursor: pointer; }
        button.ui-btn:hover { border-color: var(--neon-blue); background: #1a1a1a; }

        /* MODALS */
        .modal { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.98); z-index: 50; display: none; flex-direction: column; padding: 15px; box-sizing: border-box; }
        .modal-title { font-family: var(--font-head); font-size: 20px; color: var(--neon-blue); margin-bottom: 15px; border-bottom: 1px solid #333; }
        .grid-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; overflow-y: auto; padding-bottom: 20px; }
        .card { background: #151515; border: 1px solid #333; padding: 10px; text-align: center; border-radius: 4px; font-size: 12px; }

        @keyframes holoFloat { 0%{transform:translateY(0); opacity: 0.9;} 50%{transform:translateY(-5px); opacity: 1;} 100%{transform:translateY(0); opacity: 0.9;} }
        @keyframes pulseRed { 0%{background:rgba(255,0,85,0.2)} 50%{background:rgba(255,0,85,0.6)} 100%{background:rgba(255,0,85,0.2)} }
        .attack-anim { animation: shake 0.3s; }
        @keyframes shake { 0%{transform: translateX(0)} 25%{transform: translateX(10px)} 75%{transform: translateX(-10px)} 100%{transform: translateX(0)} }
    </style>
</head>
<body>

<div id="device">
    
    <!-- CAPA TRANSICI√ìN -->
    <div id="transition-layer"></div>

    <!-- PANTALLA INTRO -->
    <div id="intro-screen">
        <div style="font-size:30px; margin-bottom:20px; color:var(--neon-blue); text-align:center;">üí† POKENGINEER v23</div>
        
        <div id="story-display" class="typewriter-text"></div>

        <div id="intro-form">
            <div class="input-group">
                <label style="color:var(--neon-green); font-size:12px; display:block; margin-bottom:5px;">ID DE INGENIERO:</label>
                <input type="text" id="player-name-input" placeholder="INGRESAR NOMBRE..." maxlength="12">
            </div>

            <div style="color:var(--neon-green); font-size:12px; margin-bottom:5px; text-align:center;">SELECCIONA UNIDAD INICIAL:</div>
            <div class="starter-container">
                <div class="starter-card" onclick="selectStarter(2)">
                    <div style="font-size:30px">‚ö°</div>
                    <div style="color:#ff0">Sparky</div>
                    <small>Agilidad</small>
                </div>
                <div class="starter-card" onclick="selectStarter(5)">
                    <div style="font-size:30px">üî•</div>
                    <div style="color:#f50">Ember</div>
                    <small>Potencia</small>
                </div>
                <div class="starter-card" onclick="selectStarter(4)">
                    <div style="font-size:30px">üíß</div>
                    <div style="color:#0cf">Drip</div>
                    <small>Blindaje</small>
                </div>
            </div>

            <button onclick="confirmStart()" style="padding:15px; background:var(--neon-blue); color:#000; border:none; font-weight:bold; font-family:var(--font-head); cursor:pointer;">INICIAR SISTEMA</button>
        </div>
    </div>

    <!-- VIEW: MAPA -->
    <div id="view-map" class="view-layer">
        <header>
            <div>
                <div style="font-size:9px; color:#888;">OPERADOR</div>
                <div style="font-family:var(--font-head); color:var(--neon-green);" id="ui-player-name">PLAYER</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:9px; color:#888;">SECTOR</div>
                <div style="color:#fff; font-weight:bold;">PISO <span id="map-floor">1</span></div>
            </div>
        </header>
        
        <div id="map-container"></div>

        <div id="map-ui">
            <div class="map-stats">
                <span>OBJETIVO: <span id="kill-count" style="color:#fff">0</span>/15</span>
                <span>CR: <span id="map-cr" style="color:var(--neon-gold)">0</span></span>
            </div>
            
            <div class="dpad-container">
                <div class="dpad">
                    <div></div><div class="dpad-btn" onclick="movePlayer(0, -1)">‚ñ≤</div><div></div>
                    <div class="dpad-btn" onclick="movePlayer(-1, 0)">‚óÄ</div><div class="dpad-center"></div><div class="dpad-btn" onclick="movePlayer(1, 0)">‚ñ∂</div>
                    <div></div><div class="dpad-btn" onclick="movePlayer(0, 1)">‚ñº</div><div></div>
                </div>
            </div>

            <div class="map-menu-bar">
                <button class="map-menu-btn" onclick="openBag()">üéí ITEMS</button>
                <button class="map-menu-btn" onclick="openPokedex()">üì± DEX</button>
                <button class="map-menu-btn" onclick="openShop()">üõí SHOP</button>
                <button class="map-menu-btn" onclick="openTeam()">üë• TEAM</button>
            </div>
        </div>
    </div>

    <!-- VIEW: BATALLA -->
    <div id="view-battle" class="view-layer">
        <header>
            <div class="header-title" style="color:var(--neon-pink)">ALERTA DE COMBATE</div>
        </header>

        <div id="arena">
            <!-- Enemy -->
            <div class="mon-container enemy">
                <div class="hud">
                    <div style="display:flex; justify-content:space-between;">
                        <span id="e-name">ENEMY</span> <span id="e-lvl" style="color:var(--neon-pink)">Nv.1</span>
                    </div>
                    <div class="bar-wrap"><div id="e-hp" class="hp-fill" style="width:100%"></div></div>
                </div>
                <div class="holo-chip"><div id="e-sprite" class="holo-sprite">ü§ñ</div></div>
            </div>

            <!-- Player -->
            <div class="mon-container player">
                <div class="holo-chip"><div id="p-sprite" class="holo-sprite">üßë‚ÄçüöÄ</div></div>
                <div class="hud">
                    <div style="display:flex; justify-content:space-between;">
                        <span id="p-name">PLAYER</span> <span id="p-lvl" style="color:var(--neon-green)">Nv.1</span>
                    </div>
                    <div class="bar-wrap"><div id="p-hp" class="hp-fill" style="width:100%"></div></div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px;">
                        <div style="font-size:9px; color:var(--neon-blue);">XP</div>
                        <div class="xp-wrap"><div id="p-xp" class="xp-fill"></div></div>
                    </div>
                    <div style="text-align:right; font-size:9px; margin-top:2px;" id="p-hp-txt">100/100</div>
                </div>
            </div>
        </div>

        <div id="console"></div>

        <div id="controls">
            <div id="combat-menu" class="atk-grid"></div>
            <!-- SE AGREGO EL BOTON DE CAMBIO -->
            <div style="display:grid; grid-template-rows:1fr 1fr 1fr; gap:2px;">
                <button class="ui-btn" onclick="openBag()">üéí ITEMS</button>
                <button class="ui-btn" onclick="openTeam()">üë• CAMBIO</button>
                <button class="ui-btn" onclick="runAway()" style="color:#aaa;">üèÉ HUIR</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-bag" class="modal">
        <div class="modal-title">MOCHILA</div>
        <div id="bag-list" class="grid-list"></div>
        <button class="ui-btn" onclick="closeModal('modal-bag')" style="margin-top:auto; padding:15px;">VOLVER</button>
    </div>

    <div id="modal-shop" class="modal">
        <div class="modal-title">TIENDA (CR: <span id="shop-cr-disp">0</span>)</div>
        <div id="shop-list" class="grid-list"></div>
        <button class="ui-btn" onclick="closeModal('modal-shop')" style="margin-top:auto; padding:15px;">VOLVER</button>
    </div>

    <div id="modal-team" class="modal">
        <div class="modal-title">EQUIPO</div>
        <div id="team-list" style="overflow-y:auto; flex-grow:1; display:flex; flex-direction:column; gap:5px;"></div>
        <button class="ui-btn" onclick="closeModal('modal-team')" style="margin-top:10px; padding:15px;">VOLVER</button>
    </div>

    <div id="modal-dex" class="modal">
        <div class="modal-title">BASE DE DATOS</div>
        <div id="dex-list" class="grid-list" style="grid-template-columns: 1fr; gap:5px;"></div>
        <button class="ui-btn" onclick="closeModal('modal-dex')" style="margin-top:auto; padding:15px;">VOLVER</button>
    </div>

</div>

<script>
    /* === CONFIGURACI√ìN === */
    const MAP_SIZE = 13;
    const ENCOUNTERS_TO_BOSS = 15;
    
    // CONFIG COLORES
    const TYPES = { FUEGO:'fuego', AGUA:'agua', PLANTA:'planta', MECH:'mech', ELEC:'elec', DARK:'dark' };
    
    const TYPE_COLORS = {
        'fuego': '#ff4400', 'agua': '#0088ff', 'planta': '#00cc44',
        'mech': '#777777', 'elec': '#ddbb00', 'dark': '#6600cc', 'normal': '#444444'
    };

    const RAW_DB = [
        // PISO 1 (0-9)
        {n:"Bit Bug", s:"üêû", t:TYPES.PLANTA}, {n:"Wire Worm", s:"üêõ", t:TYPES.MECH}, {n:"Sparky", s:"‚ö°", t:TYPES.ELEC},
        {n:"Pebble", s:"ü™®", t:TYPES.MECH}, {n:"Drip", s:"üíß", t:TYPES.AGUA}, {n:"Ember", s:"üî•", t:TYPES.FUEGO},
        {n:"Leafy", s:"üçÉ", t:TYPES.PLANTA}, {n:"Batty", s:"ü¶á", t:TYPES.DARK}, {n:"Rat-X", s:"üêÄ", t:TYPES.MECH}, {n:"Slime", s:"ü¶†", t:TYPES.AGUA},
        // PISO 2 (10-19)
        {n:"Cyber Wolf", s:"üê∫", t:TYPES.MECH}, {n:"Flame Fox", s:"ü¶ä", t:TYPES.FUEGO}, {n:"Aqua Fish", s:"üêü", t:TYPES.AGUA},
        {n:"Thunder Bird", s:"ü¶Ö", t:TYPES.ELEC}, {n:"Vine Snake", s:"üêç", t:TYPES.PLANTA}, {n:"Ghost Shell", s:"üëª", t:TYPES.DARK},
        {n:"Iron Crab", s:"ü¶Ä", t:TYPES.MECH}, {n:"Magma Ant", s:"üêú", t:TYPES.FUEGO}, {n:"Deep Squid", s:"ü¶ë", t:TYPES.AGUA}, {n:"Zap Cat", s:"üê±", t:TYPES.ELEC},
        // PISO 3 (20-29)
        {n:"Mech Gorilla", s:"ü¶ç", t:TYPES.MECH}, {n:"Solar Lion", s:"ü¶Å", t:TYPES.FUEGO}, {n:"Tsunami Shark", s:"ü¶à", t:TYPES.AGUA},
        {n:"Volt Bear", s:"üêª", t:TYPES.ELEC}, {n:"Forest Trex", s:"ü¶ñ", t:TYPES.PLANTA}, {n:"Shadow Owl", s:"ü¶â", t:TYPES.DARK},
        {n:"Steel Rhino", s:"ü¶è", t:TYPES.MECH}, {n:"Lava Golem", s:"üë∫", t:TYPES.FUEGO}, {n:"Ice Whale", s:"üêã", t:TYPES.AGUA}, {n:"Storm Hawk", s:"ü¶Ö", t:TYPES.ELEC},
        // PISO 4 (30-39)
        {n:"Plasma Dragon", s:"üêâ", t:TYPES.ELEC}, {n:"Inferno Drake", s:"üê≤", t:TYPES.FUEGO}, {n:"Bio Titan", s:"ü¶ï", t:TYPES.PLANTA},
        {n:"Neon Tiger", s:"üêÖ", t:TYPES.ELEC}, {n:"Abyss Croc", s:"üêä", t:TYPES.AGUA}, {n:"Void Spirit", s:"üëΩ", t:TYPES.DARK},
        {n:"Mecha Zilla", s:"ü¶é", t:TYPES.MECH}, {n:"Scorpion K", s:"ü¶Ç", t:TYPES.DARK}, {n:"Spider Web", s:"üï∑Ô∏è", t:TYPES.MECH}, {n:"Uni Horn", s:"ü¶Ñ", t:TYPES.PLANTA},
        // PISO 5 (40-49)
        {n:"OMEGA", s:"üßø", t:TYPES.MECH}, {n:"PHOENIX", s:"ü¶Ö", t:TYPES.FUEGO}, {n:"KRAKEN", s:"üêô", t:TYPES.AGUA},
        {n:"ZEUS", s:"‚ö°", t:TYPES.ELEC}, {n:"GAIA", s:"üå≥", t:TYPES.PLANTA}, {n:"HADES", s:"üíÄ", t:TYPES.DARK},
        {n:"CHRONOS", s:"‚è≥", t:TYPES.MECH}, {n:"COSMOS", s:"üåå", t:TYPES.DARK}, {n:"SOL", s:"‚òÄÔ∏è", t:TYPES.FUEGO}, {n:"LUNA", s:"üåô", t:TYPES.DARK}
    ];

    const MOVES = {
        'Golpe': {p:40, pp:35, t:'normal'}, 'Rayo': {p:60, pp:20, t:TYPES.ELEC}, 'Fuego': {p:60, pp:20, t:TYPES.FUEGO}, 
        'Agua': {p:60, pp:20, t:TYPES.AGUA}, 'Hoja': {p:60, pp:20, t:TYPES.PLANTA}, 'Metal': {p:70, pp:15, t:TYPES.MECH},
        'Oscuro': {p:70, pp:15, t:TYPES.DARK}, 'Ultimate': {p:120, pp:5, t:'normal'}
    };

    // ITEM UPDATE: NUEVOS ITEMS
    const ITEMS = {
        'ball': {n:"Data Ball", price:100, icon:"üîµ", rate:1},
        'ultra': {n:"Master Ball", price:1000, icon:"üü£", rate:3},
        'pot': {n:"Poci√≥n HP", price:200, icon:"üíä", heal:50},
        'maxpot': {n:"Refrig. L√≠q.", price:600, icon:"üß™", heal:9999}, // Nuevo
        'revive': {n:"Kit Reinicio", price:500, icon:"‚ôªÔ∏è"},
        'chip': {n:"Chip Overclock", price:1200, icon:"üíæ", xp:100} // Nuevo
    };

    /* === ESTADO DEL JUEGO === */
    let game = {
        playerName: "Engineer",
        credits: 800, // Un poco m√°s de inicio
        floor: 1, team: [], active: 0, pokedex: [],
        inv: { ball:5, ultra:0, pot:3, maxpot:1, revive:0, chip:0 },
        playerX: 6, playerY: 6, mapData: [],
        progress: 0, enemy: null, turn: true
    };

    let selectedStarterId = null;

    /* === INTRO ANIMATION === */
    const STORY_TEXT = "INICIANDO SISTEMA...\n\n> A√ëO: 2140\n> UBICACI√ìN: SECTOR CERO\n> ESTADO: CR√çTICO\n\nINFORME:\nEl n√∫cleo de la IA Global ha sido corrompido.\nLas m√°quinas se han vuelto hostiles.\n\nTU MISI√ìN:\nReiniciar el servidor central.\n\nCARGANDO INTERFAZ DE USUARIO...";

    let charIndex = 0;
    function typeWriter() {
        if (charIndex < STORY_TEXT.length) {
            document.getElementById("story-display").innerHTML += STORY_TEXT.charAt(charIndex);
            charIndex++;
            setTimeout(typeWriter, 30); // Velocidad de tipeo
        } else {
            setTimeout(() => {
                document.getElementById('intro-form').classList.add('visible');
            }, 500);
        }
    }
    window.onload = () => {
        setTimeout(typeWriter, 500);
    };

    /* === SETUP === */
    window.addEventListener('keydown', (e) => {
        const isMap = document.getElementById('view-map').classList.contains('active');
        const noModal = document.querySelector('.modal[style*="flex"]') === null;
        if (isMap && noModal) {
            switch(e.key.toLowerCase()) {
                case 'arrowup': case 'w': movePlayer(0, -1); break;
                case 'arrowdown': case 's': movePlayer(0, 1); break;
                case 'arrowleft': case 'a': movePlayer(-1, 0); break;
                case 'arrowright': case 'd': movePlayer(1, 0); break;
            }
        }
    });

    function selectStarter(id) {
        selectedStarterId = id;
        document.querySelectorAll('.starter-card').forEach(c => c.classList.remove('selected'));
        const cards = document.querySelectorAll('.starter-card');
        if(id===2) cards[0].classList.add('selected');
        if(id===5) cards[1].classList.add('selected');
        if(id===4) cards[2].classList.add('selected');
    }

    function confirmStart() {
        const nameInput = document.getElementById('player-name-input').value.trim();
        if(nameInput.length > 0) game.playerName = nameInput;
        if(selectedStarterId === null) return alert("¬°SELECCIONA UNA UNIDAD!");

        document.getElementById('intro-screen').style.display = 'none';
        startGame(selectedStarterId);
    }

    function startGame(starterId) {
        document.getElementById('ui-player-name').innerText = game.playerName.toUpperCase();
        game.team.push(createMon(starterId, 5));
        game.pokedex.push(starterId);
        generateMap();
        renderMapUI();
        switchView('map');
    }

    function switchView(v) {
        document.querySelectorAll('.view-layer').forEach(e => e.classList.remove('active'));
        document.getElementById(`view-${v}`).classList.add('active');
        if(v==='map') renderMap();
    }

    /* === ANIMACION ENCUENTRO === */
    function triggerEncounterAnim(callback) {
        const l = document.getElementById('transition-layer');
        l.classList.remove('anim-flash');
        void l.offsetWidth; // trigger reflow
        l.classList.add('anim-flash');
        setTimeout(() => {
            callback();
        }, 250); // Cambio de vista en el punto m√°s blanco
    }

    /* === MAPA === */
    function generateMap() {
        game.mapData = [];
        game.progress = 0; 
        document.getElementById('map-container').style.gridTemplateColumns = `repeat(${MAP_SIZE}, 1fr)`;
        document.getElementById('map-container').style.gridTemplateRows = `repeat(${MAP_SIZE}, 1fr)`;

        for(let y=0; y<MAP_SIZE; y++) {
            let row = [];
            for(let x=0; x<MAP_SIZE; x++) {
                if(x===0||x===MAP_SIZE-1||y===0||y===MAP_SIZE-1) row.push(1); 
                else if(Math.random()<0.1) row.push(1); 
                else if(Math.random()<0.3) row.push(2); 
                else row.push(0);
            }
            game.mapData.push(row);
        }
        let mid = Math.floor(MAP_SIZE/2);
        game.mapData[mid][mid] = 0;
        game.playerX = mid; game.playerY = mid;
    }

    function renderMap() {
        const c = document.getElementById('map-container'); c.innerHTML = '';
        for(let y=0; y<MAP_SIZE; y++) {
            for(let x=0; x<MAP_SIZE; x++) {
                const t = game.mapData[y][x];
                const d = document.createElement('div');
                d.className = 'tile';
                if(t===1) d.classList.add('tile-wall');
                else if(t===2) d.classList.add('tile-grass');
                else if(t===3) { d.classList.add('tile-boss'); d.innerHTML='‚ö†Ô∏è'; }
                else if(t===4) { d.classList.add('tile-lock'); d.innerHTML='üîí'; } 
                else d.classList.add('tile-floor');
                if(x===game.playerX && y===game.playerY) d.innerHTML = '<div class="entity-player">üßë‚ÄçüöÄ</div>';
                c.appendChild(d);
            }
        }
        renderMapUI();
    }

    function renderMapUI() {
        document.getElementById('map-floor').innerText = game.floor;
        document.getElementById('kill-count').innerText = game.progress;
        document.getElementById('map-cr').innerText = game.credits;
    }

    function movePlayer(dx, dy) {
        const nx = game.playerX + dx, ny = game.playerY + dy;
        const t = game.mapData[ny][nx];
        if(t===1) return; 

        game.playerX = nx; game.playerY = ny;
        renderMap();

        if(t===3) {
            triggerEncounterAnim(() => initBattle(true));
        } else if(t===2 && Math.random()<0.3) {
            triggerEncounterAnim(() => initBattle(false));
        }
    }

    /* === BATALLA === */
    function createMon(id, lvl) {
        const d = RAW_DB[id];
        const hp = Math.floor(60 + lvl*12);
        let mvs = ['Golpe'];
        if(d.t===TYPES.FUEGO) mvs.push('Fuego');
        if(d.t===TYPES.AGUA) mvs.push('Agua');
        if(d.t===TYPES.ELEC) mvs.push('Rayo');
        if(d.t===TYPES.MECH) mvs.push('Metal');
        if(d.t===TYPES.PLANTA) mvs.push('Hoja');
        if(d.t===TYPES.DARK) mvs.push('Oscuro');
        if(lvl>20) mvs.push('Ultimate');
        
        let finalMoves = mvs.map(k=>({n:k, ...MOVES[k], maxPP:MOVES[k].pp, pp:MOVES[k].pp}));
        return { 
            id:id, ...d, lvl:lvl, maxHp:hp, hp:hp, xp:0, xpMax:lvl*50, 
            moves:finalMoves, shiny: Math.random()<0.05
        };
    }

    function initBattle(isBoss) {
        game.turn = true;
        let id, lvl;
        if(isBoss) {
            id = (game.floor * 10) - 1; 
            lvl = game.floor * 10 + 5;
            game.enemy = createMon(id, lvl);
            game.enemy.maxHp *= 2; game.enemy.hp = game.enemy.maxHp;
            game.enemy.boss = true;
        } else {
            const minId = (game.floor-1)*10;
            const maxId = minId + 8; 
            id = Math.floor(Math.random()*(maxId-minId+1)) + minId;
            if(id >= RAW_DB.length) id = RAW_DB.length-1;
            lvl = Math.max(1, (game.floor-1)*10 + Math.floor(Math.random()*8));
            game.enemy = createMon(id, lvl);
        }
        switchView('battle');
        log(`ENEMIGO DETECTADO: ${game.enemy.n}`);
        updateBattleUI();
    }

    function attack(i) {
        if(!game.turn) return;
        const p = game.team[game.active];
        const m = p.moves[i];
        if(m.pp<=0) return alert("Sin Energ√≠a (PP)");
        
        m.pp--;
        document.getElementById('p-sprite').parentElement.classList.add('attack-anim');
        setTimeout(()=>document.getElementById('p-sprite').parentElement.classList.remove('attack-anim'),300);

        const dmg = Math.floor((p.lvl*0.5 + m.p/2) * (Math.random()*0.4 + 0.8));
        game.enemy.hp -= dmg;
        log(`${p.n} usa ${m.n}! Da√±o: ${dmg}`);

        updateBattleUI();

        if(game.enemy.hp<=0) {
            game.enemy.hp=0;
            setTimeout(winBattle, 1000);
        } else {
            game.turn = false;
            setTimeout(enemyAttack, 1000);
        }
    }

    function enemyAttack() {
        const e = game.enemy;
        const p = game.team[game.active];
        const dmg = Math.floor((e.lvl*0.5 + 20) * (Math.random()*0.4 + 0.8));
        
        document.getElementById('e-sprite').parentElement.classList.add('attack-anim');
        setTimeout(()=>document.getElementById('e-sprite').parentElement.classList.remove('attack-anim'),300);

        p.hp -= dmg;
        log(`${e.n} ataca! Da√±o: ${dmg}`);

        if(p.hp<=0) {
            p.hp=0;
            log("¬°SISTEMA ABATIDO!");
            if(game.team.some(m=>m.hp>0)) openTeam();
            else {
                alert("FALLO DE MISI√ìN. REINICIANDO PROTOCOLO...");
                game.team.forEach(m=>m.hp=m.maxHp);
                game.playerX=Math.floor(MAP_SIZE/2); game.playerY=game.playerX;
                switchView('map');
            }
        }
        game.turn = true;
        updateBattleUI();
    }

    function winBattle() {
        const reward = game.enemy.lvl * 20;
        game.credits += reward;
        const p = game.team[game.active];
        // XP BOOSTED (x2.5)
        const earnedXP = game.enemy.lvl * 25; 
        gainXp(p, earnedXP);

        if(game.enemy.boss) {
            alert(`SECTOR ${game.floor} PURGADO.`);
            game.floor++;
            if(game.floor > 5) { alert("¬°N√öCLEO REINICIADO!"); game.floor=1; location.reload(); return; }
            generateMap();
        } else {
            game.progress++;
            game.mapData[game.playerY][game.playerX] = 0; 
            if(game.progress === ENCOUNTERS_TO_BOSS) {
                let bx, by;
                do { bx=Math.floor(Math.random()*MAP_SIZE); by=Math.floor(Math.random()*MAP_SIZE); }
                while(game.mapData[by][bx] === 1);
                game.mapData[by][bx] = 3;
                alert("¬°SE√ëAL DE JEFE DETECTADA!");
            }
        }
        setTimeout(()=>switchView('map'), 1500);
    }

    function gainXp(mon, amount) {
        mon.xp += amount;
        log(`${mon.n} obtuvo ${amount} XP.`);
        if(mon.xp >= mon.xpMax) {
            mon.lvl++; mon.xp=0; mon.maxHp+=15; mon.hp=mon.maxHp; mon.xpMax=mon.lvl*50;
            log(`¬°SUBIDA DE NIVEL: ${mon.lvl}!`);
        }
        updateBattleUI();
    }

    function runAway() {
        if(game.enemy.boss) return log("¬°ERROR! Retirada bloqueada.");
        if(Math.random()>0.4) {
            log("Retirada t√°ctica exitosa.");
            setTimeout(()=>switchView('map'),500);
        } else {
            log("Fallo al retirar.");
            setTimeout(enemyAttack,500);
        }
    }

    function updateBattleUI() {
        const p = game.team[game.active];
        if (!p) return;
        const e = game.enemy;
        
        document.getElementById('p-name').innerText = p.n;
        document.getElementById('p-lvl').innerText = "Nv."+p.lvl;
        document.getElementById('p-sprite').innerText = p.s;
        
        let php = (p.hp/p.maxHp)*100;
        document.getElementById('p-hp').style.width = php+"%";
        document.getElementById('p-hp-txt').innerText = `${p.hp}/${p.maxHp}`;
        
        let pxp = (p.xp / p.xpMax) * 100;
        document.getElementById('p-xp').style.width = pxp+"%";

        if(e) {
            document.getElementById('e-name').innerText = e.n;
            document.getElementById('e-lvl').innerText = "Nv."+e.lvl;
            document.getElementById('e-sprite').innerText = e.s;
            document.getElementById('e-hp').style.width = ((e.hp/e.maxHp)*100)+"%";
        }

        const mg = document.getElementById('combat-menu'); mg.innerHTML='';
        p.moves.forEach((m,i)=>{
            const color = TYPE_COLORS[m.t] || TYPE_COLORS['normal'];
            mg.innerHTML += `
            <button class="atk-btn" onclick="attack(${i})" 
                style="background:${color}; border-color:rgba(255,255,255,0.5);">
                ${m.n}
                <small>PP:${m.pp}/${m.maxPP}</small>
            </button>`;
        });
    }

    function log(t) {
        const c = document.getElementById('console');
        c.innerHTML = `<div class="log-entry">> ${t}</div>` + c.innerHTML;
    }

    /* === MENUS Y MODALS === */
    function openBag() {
        const l = document.getElementById('bag-list'); l.innerHTML='';
        for(let k in game.inv) {
            if(game.inv[k]>0) {
                const it = ITEMS[k];
                l.innerHTML += `
                <div class="card">
                    <div class="card-icon">${it.icon}</div>
                    <div>${it.n}</div><small>x${game.inv[k]}</small><br>
                    <button class="ui-btn" style="margin-top:5px; width:100%" onclick="useItem('${k}')">USAR</button>
                </div>`;
            }
        }
        document.getElementById('modal-bag').style.display='flex';
    }

    function useItem(k) {
        const inBattle = document.getElementById('view-battle').classList.contains('active');
        if(k.includes('ball')) {
            if(!inBattle) return alert("Solo combate");
            if(game.enemy.boss) return alert("Objetivo Inmune");
            game.inv[k]--;
            closeModal('modal-bag');
            log("Ejecutando captura...");
            setTimeout(()=>{
                const rate = ITEMS[k].rate * 0.3 + (1 - game.enemy.hp/game.enemy.maxHp);
                if(Math.random() < rate) {
                    game.enemy.hp = game.enemy.maxHp; 
                    game.team.push(game.enemy);
                    if(!game.pokedex.includes(game.enemy.id)) game.pokedex.push(game.enemy.id);
                    log("¬°Unidad asimilada exitosamente!");
                    setTimeout(()=>winBattle(),1000);
                } else {
                    log("Fallo de asimilaci√≥n.");
                    setTimeout(enemyAttack, 1000);
                }
            }, 1000);
        } else if(ITEMS[k].heal || k==='revive' || ITEMS[k].xp) {
            closeModal('modal-bag');
            openTeam(false, true, k);
        }
    }

    let pendingItem = null;
    function openTeam(swap=false, itemMode=false, itemKey=null) {
        pendingItem = itemKey;
        const l = document.getElementById('team-list'); l.innerHTML='';
        game.team.forEach((m,i)=>{
            let btn = '';
            if(itemMode) btn = `<button class="ui-btn" onclick="applyItem(${i})">USAR</button>`;
            else if(i!==game.active && m.hp>0) btn = `<button class="ui-btn" onclick="swapMon(${i})">CAMBIAR</button>`;
            l.innerHTML += `
            <div style="background:#111; border:1px solid #333; padding:10px; display:flex; align-items:center; gap:10px;">
                <div style="font-size:30px;">${m.s}</div>
                <div style="flex-grow:1;">
                    <div style="font-weight:bold; color:${i===game.active?'var(--neon-green)':'#fff'}">${m.n} Nv.${m.lvl}</div>
                    <div style="font-size:10px; color:#aaa;">HP: ${m.hp}/${m.maxHp}</div>
                </div>
                <div>${btn}</div>
            </div>`;
        });
        document.getElementById('modal-team').style.display='flex';
    }

    function applyItem(idx) {
        const m = game.team[idx];
        const it = ITEMS[pendingItem];
        let used = false;

        if(pendingItem==='pot' || pendingItem==='maxpot') {
            if(m.hp < m.maxHp) {
                m.hp += it.heal;
                if(m.hp > m.maxHp) m.hp = m.maxHp;
                used = true;
            } else alert("HP al m√°ximo");
        }
        else if(pendingItem==='revive') {
            if(m.hp <= 0) { m.hp = Math.floor(m.maxHp/2); used=true; }
            else alert("Unidad operativa");
        }
        else if(it.xp) {
            gainXp(m, it.xp);
            used = true;
            alert("Chip instalado. Rendimiento aumentado.");
        }

        if(used) {
            game.inv[pendingItem]--;
            closeModal('modal-team');
            const inBattle = document.getElementById('view-battle').classList.contains('active');
            if(inBattle) { updateBattleUI(); if(game.turn) setTimeout(enemyAttack, 500); }
            else openTeam();
        }
    }

    function swapMon(idx) {
        game.active = idx;
        closeModal('modal-team');
        const inBattle = document.getElementById('view-battle').classList.contains('active');
        if(inBattle) {
            updateBattleUI();
            log(`Activando: ${game.team[idx].n}`);
            game.turn = false;
            setTimeout(enemyAttack, 1000);
        }
    }

    function openShop() {
        document.getElementById('shop-cr-disp').innerText = game.credits;
        const l = document.getElementById('shop-list'); l.innerHTML='';
        for(let k in ITEMS) {
            const it = ITEMS[k];
            l.innerHTML += `
            <div class="card">
                <div class="card-icon">${it.icon}</div>
                <div>${it.n}</div><div style="color:gold">${it.price}CR</div>
                <button class="ui-btn" style="margin-top:5px; width:100%" onclick="buy('${k}')">COMPRAR</button>
            </div>`;
        }
        document.getElementById('modal-shop').style.display='flex';
    }

    function buy(k) {
        const p = ITEMS[k].price;
        if(game.credits>=p) {
            game.credits-=p; game.inv[k]++;
            document.getElementById('shop-cr-disp').innerText = game.credits;
            renderMapUI();
        } else alert("Cr√©ditos insuficientes");
    }

    function openPokedex() {
        const l = document.getElementById('dex-list'); l.innerHTML='';
        RAW_DB.forEach((dbMon, i) => {
            const caught = game.pokedex.includes(i);
            l.innerHTML += `
            <div style="background:${caught?'#111':'#000'}; border:1px solid ${caught?'var(--neon-blue)':'#333'}; padding:5px; display:flex; align-items:center;">
                <div style="width:30px; font-size:20px;">${caught ? dbMon.s : '‚ùì'}</div>
                <div style="color:${caught?'#fff':'#555'}">#${i} ${caught ? dbMon.n : 'UNKNOWN'}</div>
                <div style="margin-left:auto; font-size:10px; color:#aaa;">${caught ? dbMon.t.toUpperCase() : ''}</div>
            </div>`;
        });
        document.getElementById('modal-dex').style.display='flex';
    }

    function closeModal(id) { document.getElementById(id).style.display='none'; }

</script>
</body>
</html>
